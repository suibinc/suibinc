(window.webpackJsonp=window.webpackJsonp||[]).push([[1],{402:function(e,n,r){var content=r(412);"string"==typeof content&&(content=[[e.i,content,""]]),content.locals&&(e.exports=content.locals);(0,r(17).default)("55289074",content,!0,{sourceMap:!1})},408:function(e,n,r){e.exports=r.p+"img/0d8307d.png"},409:function(e,n,r){e.exports=r.p+"img/16d8753.png"},410:function(e){e.exports={route:"article/2017-12-19",title:"Vue SSR 内存泄露分析",intro:"前后端分离后尝试服务端渲染，踩坑过程中遇到的一次内存泄露问题，这次内存泄露速度慢，不易察觉，线上访问量大到一定程度后才被察觉，本文为记录此次事故的原因及解决办法......",date:"2017-12-19",tags:["内存泄露","VUE","SSR"],meta:{}}},411:function(e,n,r){"use strict";var t=r(402);r.n(t).a},412:function(e,n,r){(e.exports=r(16)(!1)).push([e.i,"",""])},428:function(e,n,r){"use strict";r.r(n);var t=[function(){var e=this,n=e.$createElement,t=e._self._c||n;return t("div",{staticClass:"article"},[t("p",[e._v("因业务调整，部分前端业务使用了node ssr来优化用户体验，在这期间也踩了一些坑；比如说，内存泄露、服务抖动等等，所以这里记录一下SSR重构前期遇到的一个慢内存泄露事件；")]),e._v(" "),t("p",[e._v("\n            新页面上线后几个小时，收到了报警（服务内存达到设定的阈值后会自动重启，并报警告知业务方）。查看监控后发现，短时间来看内存相对稳定，并无大幅上升趋势，但是放大到几个小时的维度。发现内存是非常缓慢上升的，怀疑有小量的内存泄露，因为测试环境访问量少，未能及时发现；")]),e._v(" "),t("p",[e._v("本地调试服务，并使用 "),t("b",[e._v("Easy-Monitor")]),e._v(" 进行分析，得到如下结果：")]),e._v(" "),t("p",[t("img",{attrs:{src:r(408),alt:""}})]),e._v(" "),t("p",[e._v("从这里可以看出，应该是_installedPlugins函数的锅（有背锅的了），初步分析应该是Vue.use函数的问题；")]),e._v(" "),t("p",[e._v("进一步查看代码执行过程，怀疑是 "),t("b",[e._v("Vue.use")]),e._v(" 函数多次 "),t("b",[e._v("push")]),e._v("\n            了组件（或指令）对象导致 "),t("b",[e._v("installedPlugins")]),e._v(" 爆炸，通过console（debug）发现，每次刷新页面下面的代码都会被执行\n            "),t("b",{staticClass:"col-code"},[e._v("plugin.install.apply(plugin, args)")]),e._v("\n            然后对象被 "),t("b",[e._v("push")]),e._v(" 至 "),t("b",[e._v("installedPlugins")]),e._v(" 数组内（因此也导致了内存泄露，访问页面100W次，"),t("b",[e._v("installedPlugins")]),e._v("\n            数组内则会有100W*N个对象），下图为 "),t("b",[e._v("Vue.use")]),e._v(" 源码：\n        ")]),e._v(" "),t("p",[t("img",{attrs:{src:r(409),alt:""}})]),e._v(" "),t("p",[e._v("\n            在上面的源码中有一个疑问点：Vue有判断 "),t("b",{staticClass:"col-code"},[e._v("if (installedPlugins.indexOf(plugin) > -1)")]),e._v("，\n            对象存在则直接 return this，为什么实际运行中没有预期返回呢？难道每次import文件时都创建了一个新的对象？\n        ")]),e._v(" "),t("p",[e._v("\n            验证上面的想法，随便建了一个test.js，内容为：\n        ")]),e._v(" "),t("pre",{staticClass:"brush:js"},[e._v('console.log("running");\n\nexport default {\n    install() {\n        // todo\n    }\n};\n\n        ')]),e._v(" "),t("p",[e._v("\n            执行代码，理论上import同一个文件（如刚刚建立的test.js文件）肯定不会重复创建新的对象，但是实际上每次刷新页面import确实会输出 "),t("b",[e._v('"running"')]),e._v(" 字符串（理论上 "),t("b",[e._v('"running"')]),e._v("\n            应该只输出一次）。那么肯定有哪个地方出现了问题，既然是服务端渲染，那么就尝试从入口函数 "),t("b",{staticClass:"col-code"},[e._v("renderToString")]),e._v(" 查找问题来源，是否可能在 "),t("b",{staticClass:"col-code"},[e._v("VueServerRenderer.createBundleRenderer.renderToString")]),e._v("\n            中出现了问题？\n        ")]),e._v(" "),t("p",[e._v("查看 "),t("b",{staticClass:"col-code"},[e._v("VueServerRenderer.createBundleRenderer")]),e._v(" 源码，逐步分析：")]),e._v(" "),t("pre",{staticClass:"brush:js"},[e._v("return function createBundleRenderer(\n    bundle,\n    rendererOptions\n) {\n    if (rendererOptions === void 0) rendererOptions = {};\n\n    var files, entry, maps;\n    var basedir = rendererOptions.basedir;\n\n    // load bundle if given filepath\n    if (\n        typeof bundle === 'string' && /\\.js(on)?$/.test(bundle) &&\n        path$1.isAbsolute(bundle)\n    ) {\n        if (fs.existsSync(bundle)) {\n            var isJSON = /\\.json$/.test(bundle);\n            basedir = basedir || path$1.dirname(bundle);\n            bundle = fs.readFileSync(bundle, 'utf-8');\n            if (isJSON) {\n                try {\n                    bundle = JSON.parse(bundle);\n                } catch (e) {\n                    throw new Error((\"Invalid JSON bundle file: \" + bundle))\n                }\n            }\n        } else {\n            throw new Error((\"Cannot locate bundle file: \" + bundle))\n        }\n    }\n\n    if (typeof bundle === 'object') {\n        entry = bundle.entry;\n        files = bundle.files;\n        basedir = basedir || bundle.basedir;\n        maps = createSourceMapConsumers(bundle.maps);\n        if (typeof entry !== 'string' || typeof files !== 'object') {\n            throw new Error(INVALID_MSG)\n        }\n    } else if (typeof bundle === 'string') {\n        entry = '__vue_ssr_bundle__';\n        files = { '__vue_ssr_bundle__': bundle };\n        maps = {};\n    } else {\n        throw new Error(INVALID_MSG)\n    }\n\n    var renderer = createRenderer(rendererOptions);\n\n    var run = createBundleRunner(\n        entry,\n        files,\n        basedir,\n        rendererOptions.runInNewContext\n    );\n    return {\n        renderToString: function (context, cb) {\n            if (typeof context === 'function') {\n                cb = context;\n                context = {};\n            }\n            run(context).catch(function (err) {\n                rewriteErrorTrace(err, maps);\n                cb(err);\n            }).then(function (app) {\n                if (app) {\n                    renderer.renderToString(app, context, function (err, res) {\n                        rewriteErrorTrace(err, maps);\n                        cb(err, res);\n                    });\n                }\n            });\n        },\n\n        renderToStream: function (context) {\n            var res = new PassThrough();\n            run(context).catch(function (err) {\n                rewriteErrorTrace(err, maps);\n                // avoid emitting synchronously before user can\n                // attach error listener\n                process.nextTick(function () {\n                    res.emit('error', err);\n                });\n            }).then(function (app) {\n                if (app) {\n                    var renderStream = renderer.renderToStream(app, context);\n\n                    renderStream.on('error', function (err) {\n                        rewriteErrorTrace(err, maps);\n                        res.emit('error', err);\n                    });\n\n                    // relay HTMLStream special events\n                    if (rendererOptions && rendererOptions.template) {\n                        renderStream.on('beforeStart', function () {\n                            res.emit('beforeStart');\n                        });\n                        renderStream.on('beforeEnd', function () {\n                            res.emit('beforeEnd');\n                        });\n                    }\n\n                    renderStream.pipe(res);\n                }\n            });\n\n            return res\n        }\n    }\n}\n\n        ")]),e._v(" "),t("p",[e._v("\n            这段代码中发现每次 "),t("b",{staticClass:"col-code"},[e._v("renderToString")]),e._v(" 时会执行 "),t("b",{staticClass:"col-code"},[e._v("createBundleRunner")]),e._v("，继续查看 "),t("b",{staticClass:"col-code"},[e._v("createBundleRunner")]),e._v(" 函数执行情况：\n        ")]),e._v(" "),t("pre",{staticClass:"brush:js"},[e._v("var evaluate = compileModule(files, basedir, runInNewContext);\n......\nrunner = evaluate(entry, sandbox); // 这里解析入口并执行代码\n        ")]),e._v(" "),t("p",[e._v("继续查看 "),t("b",{staticClass:"col-code"},[e._v("compileModule")]),e._v(" 函数：")]),e._v(" "),t("pre",{staticClass:"brush:js"},[e._v("function compileModule(files, basedir, runInNewContext) {\n    var compiledScripts = {};\n    var resolvedModules = {};\n\n    function getCompiledScript(filename) {\n        if (compiledScripts[filename]) {\n            return compiledScripts[filename]\n        }\n        var code = files[filename];\n        var wrapper = NativeModule.wrap(code);\n        var script = new vm.Script(wrapper, {\n            filename: filename,\n            displayErrors: true\n        });\n        compiledScripts[filename] = script;\n        return script\n    }\n\n    function evaluateModule(filename, sandbox, evaluatedFiles) {\n        if (evaluatedFiles === void 0) evaluatedFiles = {};\n\n        if (evaluatedFiles[filename]) {\n            return evaluatedFiles[filename]\n        }\n\n        var script = getCompiledScript(filename);\n        var compiledWrapper = runInNewContext === false\n            ? script.runInThisContext()\n            : script.runInNewContext(sandbox);\n        var m = { exports: {} };\n        var r = function (file) {\n            file = path$2.join('.', file);\n            if (files[file]) {\n                return evaluateModule(file, sandbox, evaluatedFiles)\n            } else if (basedir) {\n                return require(\n                    resolvedModules[file] ||\n                    (resolvedModules[file] = resolve.sync(file, { basedir: basedir }))\n                )\n            } else {\n                return require(file)\n            }\n        };\n        compiledWrapper.call(m.exports, m.exports, r, m);\n\n        var res = Object.prototype.hasOwnProperty.call(m.exports, 'default')\n            ? m.exports.default\n            : m.exports;\n        evaluatedFiles[filename] = res;\n        return res\n    }\n\n    return evaluateModule\n}\n\n        ")]),e._v(" "),t("p",[e._v("发现在解析执行时，对于vue、vuex、lru-cache等公共模块都是通过 "),t("b",{staticClass:"col-code"},[e._v("require(file)")]),e._v("\n            执行，而其它的模块则是直接执行一次并且创建一个新的对象，并且缓存在compiledScripts对象中（第N+1次的import则正常的不会执行console了）")]),e._v(" "),t("p",[e._v("因此，对于vue\n            ssr中的import非dependencies中的模块引入都会创建一个新的对象，而dependencies中的模块则不会，因此对于所有的往单例对象添加import自定义文件的对象的操作都会引起内存泄露。")])])}],o=r(188),l=r(410);r(31);function c(script,e){if(script instanceof Array)return script.forEach(function(e){!function e(script){if(script instanceof Array)return script.forEach(function(n){e(n)}),!0;var n=document.createElement("script");n.type="text/javascript";n.src=script;document.body.appendChild(n)}(e)}),!0;var n=document.createElement("script");n.type="text/javascript",n.src=script,e&&(n.onload=e),document.body.appendChild(n)}var d={layout:"article",components:{ArticleHeader:o.a},data:function(){return{config:l}},created:function(){this.$root.$emit("init",l)},mounted:function(){!function e(link){if(link instanceof Array)return link.forEach(function(n){e(n)}),!0;var n=document.createElement("link");n.rel="stylesheet",n.href=link,document.body.appendChild(n)}(["https://cdn.bootcss.com/SyntaxHighlighter/3.0.83/styles/shCore.css","https://cdn.bootcss.com/SyntaxHighlighter/3.0.83/styles/shCoreDefault.css"]),c("https://cdn.bootcss.com/SyntaxHighlighter/3.0.83/scripts/shCore.js",function(){if(!window.SyntaxHighlighter)return!1;window.SyntaxHighlighter.defaults.toolbar=!1,window.SyntaxHighlighter.config.bloggerMode=!0,window.SyntaxHighlighter.config.stripBrs=!0,c("https://cdn.bootcss.com/SyntaxHighlighter/3.0.83/scripts/shBrushJScript.js",function(){console.log("done."),window.SyntaxHighlighter.highlight()})})}},v=(r(411),r(10)),component=Object(v.a)(d,function(){this.$createElement;this._self._c;return this._m(0)},t,!1,null,null,null);n.default=component.exports}}]);